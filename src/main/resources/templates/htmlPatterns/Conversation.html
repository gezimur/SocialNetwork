<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>JugglersSocialNetwork</title>
    <link rel="stylesheet" type="text/css" href="../css/maincss.css">
</head>
<body class="body">
<span class="blockWithLinks">
		<a href="/authorization">my profile</a><br>
		<a href="/conversations">conversations</a><br>
		<a href="/search">search</a><br>
		<a href="/help">help</a><br>
		<a href="/singOut">sing out</a><br>
	</span>
<p class="mainBlock">
		<span>
            <span class="name">Conversation</span>
		</span>
    <span class="bigBlock">
		<input id="textLine" type="text">
		<button onclick="sendMessage()">send message</button>
		<br>
		<span id="textSpace">
		</span>
	</span>
</p>
<script>
	var lastId = 0;
	function sendMessage(){
		var message = createMessage();
		var form = createMyForm(message);
		sendForm(form);
	}
	function updateTextSpace(response){
		var i = 0;
		while (response.indexOf(";", i) < response.lastIndexOf(";")){
			sender = response.substring(i + 1, response.indexOf("/", i));
			message = response.substring(response.indexOf("/", i) + 1, response.indexOf(";", i));
			var span = document.createElement('span');
			span.className = "message";
			span.innerHTML = "<strong>" + sender + ":</strong> " + message + "<br>";
			var textSpace = document.getElementById("textSpace");
			textSpace.prepend(span);

			i = response.indexOf(";", i);
		}
	}
	function sendForm(form){
		var req = new XMLHttpRequest();
		var url = '/sendMessage';
		var response = "some problems";
		req.addEventListener('load', function(e){
			var data = e.target;
			response = data.responseText;
			lastId = response.substring(response.lastIndexOf(";") + 1);
			updateTextSpace(response);
		});
		req.open('POST', url);
		req.responseType = 'text';
		req.send(form);
	}
	function createMyForm(message){
		var form = new FormData();
		form.append("message", message);
		var pathname = window.location.pathname;
		form.append("conv", pathname.substring(pathname.lastIndexOf("/") + 3));
		form.append("lastId", lastId);
		return form;
	}
	function createMessage() {
		var textLine = document.getElementById("textLine");
		var message = textLine.value;
		textLine.value = "";
		return message;
	}
</script>
</body>
</html>