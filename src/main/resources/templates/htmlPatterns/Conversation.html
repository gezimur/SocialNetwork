<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>JugglersSocialNetwork</title>
    <link rel="stylesheet" type="text/css" href="../css/maincss.css">
</head>
<body class="body">
<span class="blockWithLinks">
		<a href="/authorization">my profile</a><br>
		<a href="/conversations">conversations</a><br>
		<a href="/search">search</a><br>
		<a href="/help">help</a><br>
		<a href="/singOut">sing out</a><br>
	</span>
<p class="mainBlock">
		<span>
            <span class="name">Conversation</span>
		</span>
    <span class="bigBlock">
		<input id="textLine" type="text">
		<button onclick="sendMessage()">send message</button>
		<br>
		<span id="textSpace">
		</span>
	</span>
</p>
<script>
	var lastId = 0;
	sendMessage();
	var timerToUpdate = setTimeout(uploadChanges, 3000);
	function uploadChanges(){
		sendForm(createMyForm(""));
		clearTimeout(timerToUpdate);
		timerToUpdate = setTimeout(uploadChanges, 3000);
	}
	function sendMessage(){
		var message = createMessage();
		var form = createMyForm(message);
		sendForm(form);
		clearTimeout(timerToUpdate);
		timerToUpdate = setTimeout(uploadChanges, 3000);
	}
	function updateTextSpace(arr){
		for (var i = 0; i < arr.length; i++){
			var span = document.createElement('span');
			span.className = "message";
			span.innerHTML = "<strong>" + arr[i].sender + ":</strong> " + arr[i].text;
			var textSpace = document.getElementById("textSpace");
			textSpace.prepend(span);
		}
	}
	function sendForm(form){
		var req = new XMLHttpRequest();
		var url = '/sendMessage';
		req.addEventListener('load', function(e){
			var data = e.target;
			var response = data.responseText;
			if (response !== "[]"){
				var arr = JSON.parse(response);
				lastId = arr[arr.length - 1].id;
				updateTextSpace(arr);
			}
		});
		req.open('POST', url);
		req.responseType = 'text';
		req.send(form);
	}
	function createMyForm(message){
		var form = new FormData();
		form.append("message", message);
		var pathname = window.location.pathname;
		form.append("conv", pathname.substring(pathname.lastIndexOf("/") + 3));
		form.append("lastId", lastId);
		return form;
	}
	function createMessage() {
		var textLine = document.getElementById("textLine");
		var message = textLine.value;
		textLine.value = "";
		return message;
	}
</script>
</body>
</html>